## HTTP/HTTPS

#### TCP连接流程
> SYN:同步信号,FIN:断开信号;ACK:1表示应答有效,0无效;SEQ:序列号.
* 三次握手
	1. c->s: SYN, seq=x(改数据包可用作SYN攻击:伪造ip发送该包,服务端回复并等待(半连接态))
	2. s->c: SYN,ACK, seq=y, ackNum=x+1
	3. c->s: ACK, ackNum=y+1
* 传输过程
	1. c->s: ACK,seq=x ackNum=y+1
	2. s->c: ACK,ack=x+1
* 四次挥手
	1. c->s: FIN, seq=x
	2. s->c: ACK,ackNum=x+1
	3. s->c: FIN seq=y
	4. c->s: ACK,ackNum=y+1

#### tcp keepalive
> 通过心跳包保活;连接存活并不保证服务可用

### HTTPS

#### TLS(早期版本为SSL)过程
1. c->s: tls版本,支持的加密,压缩算法
2. s->c: tls版本,数字证书(包含公钥)
3. c->s: CA列表验证证书, 成一串随机数(对称密钥)并通过公钥加密
4. s->c: 解密随机数,作为对称密钥
5. c->s:  发送Finished, 使用对称加密这次通讯的散列值
6. s->c: 生成Hash,解密客户端发送来的信息，检查这两个值是否对应。如果对应，就向客户端发送一个 Finished 消息，也使用协商好的对称密钥加密

1,2协商协议版本,加密方式;3,4生成对称秘钥(安全保障,公钥加密的数据,只能私钥解密);
5,6 验证对称秘钥可用.

##### 用到的加密
1. 对称加密DES、AES-GCM、ChaCha20-Poly1305等
2. 非对称加密:RSA、DSA、ECDSA、 DH、ECDHE
3. 哈希算法:MD5、SHA-1、SHA-2、SHA-256
4. 数字签名: 即 哈希后增加(信息hash后的值),防止哈哈被篡改.

##### HTTP风险
1. 窃听风险：黑客可以获知通信内容。
2. 篡改风险：黑客可以修改通信内容。
3. 冒充风险：黑客可以冒充他人身份参与通信。

##### HTTPS
1. 证书的购买和维护成本
2. 加密使用的解析,多次握手带来的性能损失
3. 依旧存在漏洞
	1. SSL剥离,强制使用http访问,可通过`HSTS`技术只允许https访问
	2. 中间人攻击,指攻击者与通讯的两端分别建立独立的联系，并交换其所收到的数据.
	3. 伪造证书攻击.伪造证书进行中间人攻击
		1. 需要攻击服务器,改变dns只想地址
		2. 需要伪造被用户信任的证书.
		3. `HPKP` 通过在头信息存储公钥指纹.发现伪造证书攻击.
		
#### HTTP并行优化
* 1.0 同一个tcp链接内串行执行,浪费大量时间等待服务器处理
* 1.1  Pipelining(管道).允许一个请求没有返回前,发送下一个请求,但返回时必须按照接收请求的顺序返回.隐患:当前面的请求超时时,形成队头阻塞,后面的会跟着超时.
* 2.0 [Multiplexing](http://www.blogjava.net/yongboy/archive/2015/03/19/423611.html?tdsourcetag=s_pctim_aiomsg),引入流的概念,流之间通过标识符区分,流之间逻辑并行.
#### HTTP2.0新增
  * 多路复用: 允许同时通过单一的 HTTP/2 连接发起多重的请求-响应消息
	* 二进制分帧: 在tcp和http中间加了一层二进制分帧层.该层会将数据切分成更小的单元(frame)
	* 流控制:阻止发送方向接受方发送大量数据的机制,(有点像rxjava背压)
	* 首部压缩.[HPACK算法](https://www.jianshu.com/p/f44b930cfcac).
	* 服务端推送.由于链接永久保持,链接启动后,可由服务端主动推送数据.
	* 永久链接,由于单链接支持了并发,就不需要多链接来并发.
  * 总结: 单连接,减少服务端链接压力;减少网络拥塞;规避了慢启动问题.
	
#### 问题记录

* `TCP_NODELAY`引起的延时问题.(连续的小数据量写操作才会触发) 
 * 后台默认值为false.修改参数为 true后恢复正常.
 * 改参数为false时开启Nagle算法.
 * Nagle算法是通过减少发包数量提高TCP/IP效率的方法.
	* 算法核心:累计包满足一下两种条件才发送:数据量>=`TCP Segment Size`,收到ACK.
 * Delayed Ack(延迟确认):另一个提升性能算法:通过延迟确认,将多个ack响应组合为一个响应发送,提高效率
	* LInus中延时默认时间为40ms.
 * 两种算法同时使用.
	* B等待ack, a触发delayed ack,40ms后发送.B按照nagle算法没有收到ack,缓存数据.


	
	
	
